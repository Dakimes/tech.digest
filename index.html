<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Главная</title>
  <meta name="description" content="Главная страница каталога: цифровой радар и карточки технологий." />
  <script>
    (function(){
      var doc = document.documentElement;
      doc.classList.add('auth-check');
      try{
        if(localStorage.getItem('sci-auth') === 'true'){
          doc.classList.add('auth-ok');
        } else {
          window.location.replace('/login/');
        }
      } catch(err){
        window.location.replace('/login/');
      }
    })();
  </script>
  <link rel="icon" type="image/png" href="./assets/logo.png" />
  <style>
    html.auth-check body{ visibility:hidden; }
    html.auth-check.auth-ok body{ visibility:visible; }
    :where([hidden]){ display:none !important; }
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --card-alt:#f1f5f9;
      --text:#0f172a;
      --muted:#64748b;
      --accent:#2563eb;
      --accent-strong:#1d4ed8;
      --accent-light:#60a5fa;
      --accent-soft:#dbeafe;
      --border:#e2e8f0;
      --shadow: 0 12px 32px rgba(15, 23, 42, .06);
      --radius:18px;
    }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font:16px/1.55 "Inter", "SF Pro Text", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width: 1100px; margin: 32px auto 80px; padding: 0 20px; }
    .account-pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 14px; border-radius:999px; font-size:12px; font-weight:600; background:var(--accent-soft); color:var(--accent); border:1px solid transparent; box-shadow:none; letter-spacing:.3px; flex-shrink:0; }

    /* Header */
    header.hero{ display:flex; align-items:center; gap:16px; padding:18px 20px; border:1px solid var(--border); border-radius:var(--radius); background:var(--card); box-shadow:var(--shadow); flex-wrap:wrap; }
    .logo{ height:52px; width:auto; }
    .brand{ font-weight:700; font-size: clamp(20px,2.4vw,24px); letter-spacing:.2px; color:var(--text); }
    .nav{ margin-left:auto; }
    .login-link{ display:inline-flex; align-items:center; gap:8px; padding:10px 18px; border-radius:12px; background:var(--card-alt); color:var(--muted); font-weight:600; text-decoration:none; box-shadow:none; border:1px solid var(--border); transition:background .2s ease, color .2s ease, transform .2s ease; }
    .login-link:hover{ background:var(--border); color:var(--text); transform:translateY(-1px); }
    .login-link:focus-visible{ outline:3px solid rgba(37,99,235,.35); outline-offset:3px; }

    /* Blue top-level taxonomy band */
    .blueband{ margin-top:18px; background:var(--card); color:var(--text); border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid var(--border); }
    .blueband .inner{ display:flex; flex-wrap:wrap; gap:14px 18px; padding:16px 20px; align-items:center; }
    .tagb{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background: var(--card-alt); border:1px solid transparent; font-size:13px; color:var(--muted); }
    .legend{ display:flex; flex-wrap:wrap; gap:12px; margin-left:auto; }
    .lg{ display:inline-flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); }
    .lg i{ width:10px; height:10px; display:inline-block; border-radius:50%; }
    .m1{ background:#bae6fd; } .m2{ background:#7dd3fc; } .m3{ background:#38bdf8; } .m4{ background:#0ea5e9; }

    /* Search */
    .search{ position:relative; display:flex; gap:12px; margin:26px 0 32px; }
    .search input{ width:100%; border:1px solid var(--border); border-radius:14px; padding:14px 14px 14px 44px; font-size:16px; outline:none; box-shadow:none; background:#fff; transition:border-color .2s ease, box-shadow .2s ease; }
    .search input:focus{ border-color: var(--accent); box-shadow:0 0 0 4px rgba(37,99,235,.12); }
    .search .clear{
      border:1px solid var(--border);
      background:var(--card);
      color:var(--muted);
      padding:12px 16px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      transition:background .2s ease, border-color .2s ease, color .2s ease;
    }
    .search .clear:hover:not(:disabled){ background:var(--card-alt); color:var(--text); border-color:var(--accent); }
    .search .clear:focus-visible{ outline:3px solid rgba(37,99,235,.2); outline-offset:3px; }
    .search .clear:disabled{
      opacity:.65;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* Radar */
    .radar-wrap{ position:relative; border:1px solid var(--border); border-radius:var(--radius); padding:22px 22px 30px; background: var(--card); box-shadow: var(--shadow); }
    .radar-toolbar{ display:flex; justify-content:flex-end; margin-bottom:16px; }
    .radar-dashboard-link{ display:inline-flex; align-items:center; gap:8px; padding:10px 18px; border-radius:12px; background:var(--accent); color:#fff; font-weight:600; text-decoration:none; border:1px solid var(--accent); box-shadow:none; transition:background .2s ease, transform .2s ease; }
    .radar-dashboard-link:hover{ background:var(--accent-strong); transform:translateY(-1px); }
    .radar-dashboard-link:focus-visible{ outline:3px solid rgba(37,99,235,.35); outline-offset:3px; }
    .radar{ position:relative; width:100%; max-width:100%; height: clamp(440px, 58vw, 620px); margin:auto; background:
      radial-gradient(circle at center, rgba(37,99,235,.05) 0 1px, transparent 1px) 0 0/22px 22px; border-radius:18px; overflow:hidden; }
    .radar-empty{
      position:absolute;
      inset:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      background:rgba(255,255,255,.92);
      border:1px dashed var(--border);
      border-radius:12px;
      color:var(--muted);
      font-weight:600;
      padding:18px;
      pointer-events:none;
    }
    .radar svg{ position:absolute; inset:0; width:100%; height:100%; }
    .ring-label{ display:block; font-size:12px; fill:var(--muted); font-weight:600; }
    .axis-line{ stroke:rgba(37,99,235,.18); stroke-width:1; stroke-dasharray:4 4; }
    .ring-zone{ stroke:rgba(37,99,235,.2); stroke-width:1.1; }

    .dot{ cursor:pointer; transition: opacity .15s ease; outline:none; }
    .dot circle{ filter: drop-shadow(0 8px 18px rgba(37, 99, 235, .18)); }
    .dot-label{ font-size:12px; font-weight:600; fill:#ffffff; text-anchor:middle; dominant-baseline:middle; paint-order:stroke; stroke:rgba(15,23,42,.14); stroke-width:3; }
    .dot:focus-visible circle{ outline:3px solid rgba(37,99,235,.35); outline-offset:2px; }
    .radar-tooltip{
      position:absolute;
      pointer-events:none;
      background:var(--card);
      color:var(--text);
      padding:12px 14px;
      border-radius:12px;
      font-size:13px;
      line-height:1.45;
      box-shadow:0 18px 38px rgba(15,23,42,.12);
      max-width:260px;
      z-index:20;
      transform:translate(-50%, -120%);
      opacity:0;
      border:1px solid var(--border);
      transition:opacity .12s ease;
    }
    .radar-tooltip.is-visible{ opacity:1; }
    .radar-tooltip strong{ display:block; font-size:14px; margin-bottom:6px; color:var(--accent); }
    .radar-tooltip span{ display:block; font-size:12px; color:var(--muted); }
    .radar-tooltip ul{ margin:6px 0 0; padding-left:18px; color:var(--muted); }
    .radar-tooltip li{ margin:2px 0; }

    /* Board */
    h2{
      margin: 32px 0 18px;
      font-size: clamp(22px,2.8vw,30px);
      color:var(--text);
      padding-bottom:10px;
      border-bottom:1px solid var(--border);
    }

    .board{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:18px; }
    .board-empty{
      margin: 18px 0 0;
      padding:20px;
      border:1px dashed var(--border);
      border-radius:14px;
      background:var(--card);
      color:var(--muted);
      text-align:center;
      font-weight:600;
      box-shadow:none;
    }
    @media (max-width: 980px){ .board{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 760px){
      header.hero{ flex-direction:column; align-items:flex-start; }
      .nav{ width:100%; display:flex; justify-content:flex-start; }
      .login-link{ width:100%; justify-content:center; }
    }
    @media (max-width: 640px){
      .board{ grid-template-columns: 1fr; }
      .radar{ height: clamp(360px, 90vw, 520px); }
      .radar-wrap{ padding:14px; }
      .radar-toolbar{ margin-bottom:12px; }
      .radar-dashboard-link{ width:100%; justify-content:center; }
    }
    @media (max-width: 480px){
      header.hero{ padding:14px; }
      .search{ flex-direction:column; }
      .search input{ padding-left:38px; }
      .radar{ height: clamp(320px, 110vw, 440px); }
    }

    @media print{
      .radar-tooltip{ display:none !important; }
    }

    .tile{ position:relative; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow: 0 14px 26px rgba(15,23,42,.04); text-decoration:none; color:inherit; display:flex; flex-direction:column; gap:12px; transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease; }
    .tile:hover{ border-color: var(--accent); box-shadow: 0 18px 34px rgba(37,99,235,.08); transform:translateY(-2px); }
    .tile .title{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .tile .num{ font-weight:600; font-size:13px; letter-spacing:.4px; color:var(--accent-strong); margin-right:8px; width:32px; height:32px; border-radius:12px; background:var(--accent-soft); display:inline-flex; align-items:center; justify-content:center; box-shadow:none; border:1px solid var(--accent-soft); flex-shrink:0; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:600; color:var(--accent); background:var(--accent-soft); border:1px solid transparent; letter-spacing:.3px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ background:var(--card-alt); border:1px solid transparent; color:var(--muted); padding:6px 10px; border-radius:10px; font-size:12px; font-weight:500; }

    footer{ color:var(--muted); font-size:12px; margin-top: 36px; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <img src="./assets/logo.png" alt="SCI logo" class="logo" />
      <div class="brand" id="projectBrand">Технологический радар</div>
      <div id="accountBadge" class="account-pill" hidden></div>
      <nav class="nav" aria-label="Главная навигация">
        <a class="login-link" href="./login/">Выйти</a>
      </nav>
    </header>

    <div class="search" role="search">
      <div class="box" style="position:relative; flex:1">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:18px; height:18px; opacity:.6"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"></circle><line x1="16.5" y1="16.5" x2="22" y2="22" stroke="currentColor" stroke-width="2"></line></svg>
        <input id="q" type="search" placeholder="Поиск по технологиям…" aria-label="Поиск по каталогу" autofocus />
      </div>
      <button class="clear" id="clearBtn" type="button">Очистить</button>
    </div>

    <section class="radar-wrap" aria-label="Цифровой радар технологий">
      <div class="radar-toolbar">
        <a class="radar-dashboard-link" href="https://datalens.yandex/unblwg4lldxmf" target="_blank" rel="noopener">Перейти в дашборд</a>
      </div>
      <div id="radar" class="radar"></div>
      <div id="radarEmpty" class="radar-empty" hidden role="status" aria-live="polite">Нет технологий для отображения. Измените поисковый запрос.</div>
    </section>

    <h2>Доска технологий</h2>
    <section id="board" class="board" aria-live="polite"></section>
    <p id="boardEmpty" class="board-empty" hidden role="status" aria-live="polite">По текущему запросу технологий не найдено. Попробуйте изменить критерии поиска.</p>

    <footer>© 2025 SciArticle</footer>
  </div>

<script>
// === ДАННЫЕ ===
// Базовый субдомен для технологии (замените на ваш домен)
// Путь на домене scisource.ru: https://scisource.ru/<slug>/
const BASE_URL = '/';
const cleanSlug = (slug = '') => slug.toString().replace(/^\/+|\/+$/g, '');
const makeLink = (slug = '') => {
  const clean = cleanSlug(slug);
  return clean ? `${BASE_URL}${clean}/` : '#';
};

const accountConfigs = {
  'Admin': {
    pageTitle: 'Технологический радар',
    themeLabel: 'Data',
    technologies: [
      {
        id:'ekg-platform',
        slug:'ekg',
        name:'Платформы корпоративных графов знаний',
        summary:'Построение и эксплуатация онтологий, фабрик данных и графовых витрин для корпоративных сценариев.',
        metrics:['RDF/OWL','SPARQL 1.2','SHACL/SHEx','JSON‑LD','PROV‑O','SKOS'],
        ring:'production',
        angle: 40
      },
      {
        id:'semantic-pipelines',
        slug:'semantic-pipelines',
        name:'Семантические конвейеры интеграции и обработки данных',
        summary:'Автоматизация извлечения и обогащения данных для RAG и аналитики через семантические пайплайны.',
        metrics:['Hybrid Vector-SQL • ANN/HNSW','ISO GQL • SPARQL 1.2 • PROV-O','Semantic Retrieval • RAG Pipelines'],
        ring:'pilot',
        angle: 110
      },
      {
        id:'streaming-platforms',
        slug:'streaming',
        name:'Распределённые платформы потоковой передачи событий',
        summary:'Надёжная доставка событий и аналитика в реальном времени для продуктовых и операционных сценариев.',
        metrics:['Event Time','Stateful Streams','Kafka/Flink','Schema Registry','Exactly-once','CloudEvents'],
        ring:'pilot',
        angle: 180
      },
      {
        id:'distributed-streaming-rt',
        slug:'streaming-rt',
        name:'Платформы распределённой потоковой обработки',
        summary:'Потоковые вычисления, CEP и SQL-процессы для миссии критичных real-time сервисов.',
        metrics:['Event Time','Watermarks','Streaming SQL','CEP','Schema Registry','Exactly-once'],
        ring:'pilot',
        angle: 250
      },
      {
        id:'blockchain-governance',
        slug:'blockchain-governance',
        name:'Корпоративные системы управления данными и целостностью',
        summary:'Трассируемость, аудит и совместимость данных через DLT и онтологические политики.',
        metrics:['RDF/RDFS','OWL 2','SPARQL 1.2','SHACL','PROV-O','OBDA/R2RML'],
        ring:'pilot',
        angle: 320
      },
      {
        id:'disaggregated-storage',
        slug:'disaggregated-storage',
        name:'Дезагрегированные распределённые архитектуры хранения',
        summary:'Отделение вычислений и хранения для масштабируемых дата-платформ с интероперабельностью.',
        metrics:['HL7 FHIR R4/R5','OMOP CDM','FHIR Bulk Data $export','Terminology Services','SMART on FHIR / OAuth 2.0','Parquet & BigQuery'],
        ring:'observe',
        angle: 10
      }
    ]
  },
  'Admin1': {
    pageTitle: 'Технологический радар',
    themeLabel: 'МИТ',
    technologies: [
      {
        id:'plg-activation',
        slug:'saas/product-led-growth',
        name:'Product-Led Growth Activation Platforms',
        summary:'In-app онбординг, персонализация и телеметрия поведения для ускорения активации пользователей.',
        metrics:['Activation cohorts','Usage telemetry','In-app guides','Progress nudges'],
        ring:'production',
        angle: 35
      },
      {
        id:'revops-automation',
        slug:'saas/revops-automation',
        name:'Revenue Operations Automation',
        summary:'Оркестрация лидов, биллинга и QBR через единый RevOps-плейбук и AI-подсказки.',
        metrics:['Billing sync','AI playbooks','Lead scoring','Pipeline health'],
        ring:'pilot',
        angle: 120
      },
      {
        id:'customer-success-ai',
        slug:'saas/customer-intelligence',
        name:'Customer Intelligence & Success AI',
        summary:'Прогноз оттока и рекомендации по расширению контрактов для команд customer success.',
        metrics:['Churn models','Expansion signals','Health scoring','Voice-of-customer AI'],
        ring:'pilot',
        angle: 210
      },
      {
        id:'pricing-experiments',
        slug:'saas/pricing-experiments',
        name:'Pricing Experimentation & Packaging',
        summary:'Динамическое тестирование тарифов и пакетов с анализом эластичности и willingness-to-pay.',
        metrics:['Elasticity modeling','Offer A/B','Usage metering','Deal desk automation'],
        ring:'observe',
        angle: 300
      }
    ]
  }
};

const defaultAccountId = 'Admin';

function resolveAccount(){
  let accountId = defaultAccountId;
  try{
    const stored = localStorage.getItem('sci-account');
    if(stored && accountConfigs[stored]){
      accountId = stored;
    }
  } catch(err){
    /* ignore */
  }
  return { id: accountId, config: accountConfigs[accountId] };
}

const { id: activeAccountId, config: activeAccountConfig } = resolveAccount();
const technologies = (activeAccountConfig?.technologies || []).map((item, index)=>{
  const metrics = Array.isArray(item.metrics) ? item.metrics : Array.isArray(item.keys) ? item.keys : [];
  const link = item.link || makeLink(item.slug || '');
  return { ...item, metrics, link, order: index + 1 };
});

const brandEl = document.getElementById('projectBrand');
const baseBrand = 'Технологический радар';
if(brandEl){
  brandEl.textContent = baseBrand;
}
const accountBadgeEl = document.getElementById('accountBadge');
if(accountBadgeEl){
  const badgeLabel = activeAccountConfig?.themeLabel;
  if(badgeLabel){
    accountBadgeEl.textContent = badgeLabel;
    accountBadgeEl.hidden = false;
  } else {
    accountBadgeEl.hidden = true;
  }
}
if(activeAccountConfig?.pageTitle){
  document.title = activeAccountConfig.pageTitle;
} else {
  document.title = baseBrand;
}

// === РАДАР ===
const radarEl = document.getElementById('radar');
const radarEmptyEl = document.getElementById('radarEmpty');
const radarWrapEl = radarEl ? radarEl.parentElement : null;
const boardEl = document.getElementById('board');
const boardEmptyEl = document.getElementById('boardEmpty');
const rings = [
  {id:'observe',   label:'Наблюдение', r:140, color:'#bae6fd'},
  {id:'pilot',     label:'Пилоты',     r:220, color:'#7dd3fc'},
  {id:'production',label:'Продукция',  r:300, color:'#38bdf8'},
  {id:'scale',     label:'Масштаб',    r:380, color:'#0ea5e9'}
];
const ringLabelsById = rings.reduce((acc, ring)=>{ acc[ring.id] = ring.label; return acc; }, {});
let lastRadarData = technologies;
let radarTooltipEl = null;
let radarTooltipTimer = null;

if(radarWrapEl){
  radarTooltipEl = radarWrapEl.querySelector('.radar-tooltip');
  if(!radarTooltipEl){
    radarTooltipEl = document.createElement('div');
    radarTooltipEl.className = 'radar-tooltip';
    radarTooltipEl.setAttribute('role','tooltip');
    radarTooltipEl.hidden = true;
    radarWrapEl.appendChild(radarTooltipEl);
  }
}

function polarToXY(cx, cy, r, angleDeg){
  const a = (angleDeg - 90) * Math.PI/180; // 0° вверх
  return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
}

function renderRadar(data){
  if(!radarEl){ return; }
  const items = Array.isArray(data) ? data : [];
  lastRadarData = items;
  const w = radarEl.clientWidth || radarEl.offsetWidth || 800;
  const h = radarEl.clientHeight || radarEl.offsetHeight || 520;
  if(radarTooltipEl){
    if(radarTooltipTimer !== null){ cancelAnimationFrame(radarTooltipTimer); radarTooltipTimer = null; }
    radarTooltipEl.classList.remove('is-visible');
    radarTooltipEl.hidden = true;
  }
  const cx = w/2, cy = h/2;
  const maxR = Math.min(w,h)/2 - 36;
  const scale = maxR / rings[rings.length-1].r;

  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

  const defs = document.createElementNS(svg.namespaceURI,'defs');
  const lg = document.createElementNS(svg.namespaceURI,'linearGradient');
  lg.setAttribute('id','grad'); lg.setAttribute('x1','0'); lg.setAttribute('x2','1');
  const s1 = document.createElementNS(svg.namespaceURI,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','var(--accent-light)');
  const s2 = document.createElementNS(svg.namespaceURI,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','var(--accent-strong)');
  lg.appendChild(s1); lg.appendChild(s2); defs.appendChild(lg); svg.appendChild(defs);

  const ringGroup = document.createElementNS(svg.namespaceURI,'g');
  rings.forEach((r, idx)=>{
    const R = r.r * scale;
    const c = document.createElementNS(svg.namespaceURI,'circle');
    c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', R);
    c.setAttribute('class','ring-zone');
    c.setAttribute('fill', idx % 2 === 0 ? 'rgba(37,99,235,.09)' : 'rgba(37,99,235,.05)');
    ringGroup.appendChild(c);

    const t = document.createElementNS(svg.namespaceURI,'text');
    t.setAttribute('x', cx);
    t.setAttribute('y', Math.max(18, cy - R + 14));
    t.setAttribute('class','ring-label');
    t.setAttribute('text-anchor','middle');
    t.textContent = r.label;
    ringGroup.appendChild(t);
  });
  svg.appendChild(ringGroup);

  const axes = document.createElementNS(svg.namespaceURI,'g');
  const axisCount = 8;
  for(let i=0;i<axisCount;i++){
    const angle = (360/axisCount)*i;
    const end = polarToXY(cx, cy, rings[rings.length-1].r * scale, angle);
    const line = document.createElementNS(svg.namespaceURI,'line');
    line.setAttribute('x1', cx); line.setAttribute('y1', cy);
    line.setAttribute('x2', end.x); line.setAttribute('y2', end.y);
    line.setAttribute('class','axis-line');
    axes.appendChild(line);
  }
  svg.appendChild(axes);

  if(!items.length){
    radarEl.innerHTML = '';
    radarEl.appendChild(svg);
    if(radarEmptyEl){ radarEmptyEl.hidden = false; }
    if(radarTooltipEl){
      if(radarTooltipTimer !== null){ cancelAnimationFrame(radarTooltipTimer); radarTooltipTimer = null; }
      radarTooltipEl.classList.remove('is-visible');
      radarTooltipEl.hidden = true;
    }
    return;
  }

  items.forEach((item, idx)=>{
    const R = (rings.find(r=>r.id===item.ring)?.r || rings[0].r) * scale;
    const pos = polarToXY(cx, cy, R, item.angle || (40 + idx*30));
    const orderLabel = (item.order || idx + 1).toString().padStart(2,'0');

    const g = document.createElementNS(svg.namespaceURI,'g');
    g.setAttribute('class','dot');
    g.setAttribute('data-id', item.id);
    g.setAttribute('data-order', orderLabel);

    const circle = document.createElementNS(svg.namespaceURI,'circle');
    circle.setAttribute('cx', pos.x); circle.setAttribute('cy', pos.y); circle.setAttribute('r', 14);
    circle.setAttribute('fill','url(#grad)');
    circle.setAttribute('stroke','var(--accent-strong)');
    circle.setAttribute('stroke-width','1');
    circle.setAttribute('aria-hidden','true');
    g.appendChild(circle);

    const label = document.createElementNS(svg.namespaceURI,'text');
    label.setAttribute('class','dot-label');
    label.setAttribute('x', pos.x);
    label.setAttribute('y', pos.y + 1);
    label.setAttribute('pointer-events','none');
    label.textContent = orderLabel;
    g.appendChild(label);

    const go = ()=> window.location.href = item.link;
    g.addEventListener('click', go);
    g.setAttribute('role','link'); g.setAttribute('tabindex','0');
    g.addEventListener('keydown', (e)=>{ if(e.key==='Enter') go(); });

    const textParts = [item.summary, ...(item.metrics || [])];
    const ariaSummary = textParts.filter(Boolean).join('. ');
    g.setAttribute('aria-label', ariaSummary ? `${orderLabel}. ${item.name}. ${ariaSummary}` : `${orderLabel}. ${item.name}`);

    const showTooltip = ()=>{
      if(!radarTooltipEl || !radarWrapEl){ return; }
      const metricsList = (item.metrics || []).slice(0,5).map(m=>`<li>${m}</li>`).join('');
      const summaryHtml = item.summary ? `<span>${item.summary}</span>` : '';
      const metricsHtml = metricsList ? `<ul>${metricsList}</ul>` : '';
      radarTooltipEl.innerHTML = `<strong>${orderLabel}. ${item.name}</strong>${summaryHtml}${metricsHtml}`;
      const wrapRect = radarWrapEl.getBoundingClientRect();
      const svgRect = svg.getBoundingClientRect();
      const scaleX = svgRect.width / w;
      const scaleY = svgRect.height / h;
      const left = svgRect.left - wrapRect.left + pos.x * scaleX;
      const top = svgRect.top - wrapRect.top + pos.y * scaleY;
      radarTooltipEl.style.left = `${left}px`;
      radarTooltipEl.style.top = `${top}px`;
      radarTooltipEl.hidden = false;
      if(radarTooltipTimer !== null){ cancelAnimationFrame(radarTooltipTimer); }
      radarTooltipTimer = requestAnimationFrame(()=>{
        radarTooltipEl.classList.add('is-visible');
        radarTooltipTimer = null;
      });
    };
    const hideTooltip = ()=>{
      if(!radarTooltipEl){ return; }
      if(radarTooltipTimer !== null){ cancelAnimationFrame(radarTooltipTimer); radarTooltipTimer = null; }
      radarTooltipEl.classList.remove('is-visible');
      radarTooltipEl.hidden = true;
    };
    g.addEventListener('mouseenter', showTooltip);
    g.addEventListener('focus', showTooltip);
    g.addEventListener('mouseleave', hideTooltip);
    g.addEventListener('blur', hideTooltip);
    g.addEventListener('touchstart', showTooltip, { passive: true });
    g.addEventListener('touchend', hideTooltip);
    g.addEventListener('touchcancel', hideTooltip);

    svg.appendChild(g);
  });

  radarEl.innerHTML = '';
  radarEl.appendChild(svg);
  if(radarEmptyEl){ radarEmptyEl.hidden = true; }
  if(radarTooltipEl){
    if(radarTooltipTimer !== null){ cancelAnimationFrame(radarTooltipTimer); radarTooltipTimer = null; }
    radarTooltipEl.classList.remove('is-visible');
    radarTooltipEl.hidden = true;
  }
}

// === ДОСКА ===
function chip(el, text){ const s=document.createElement('span'); s.className='chip'; s.textContent=text; el.appendChild(s); }

function renderBoard(list){
  if(!boardEl) return;
  const items = Array.isArray(list) ? list : [];
  boardEl.innerHTML = '';
  const hasItems = items.length > 0;
  if(boardEmptyEl){
    boardEmptyEl.hidden = hasItems;
  }
  if(!hasItems){
    return;
  }
  items.forEach((item, idx)=>{
    const a = document.createElement('a');
    a.href = item.link; a.className='tile'; a.setAttribute('data-id', item.id);

    const title = document.createElement('div'); title.className='title';
    const head = document.createElement('div');
    head.style.display = 'flex';
    head.style.alignItems = 'flex-start';
    head.style.gap = '8px';
    head.style.flex = '1';

    const number = document.createElement('span');
    number.className = 'num';
    number.textContent = (item.order || idx + 1).toString().padStart(2,'0');

    const h = document.createElement('span');
    h.style.fontWeight='600';
    h.style.flex='1';
    h.textContent=item.name;

    head.appendChild(number);
    head.appendChild(h);
    title.appendChild(head);

    const ringLabel = ringLabelsById[item.ring];
    if(ringLabel){
      const pill = document.createElement('span');
      pill.className = 'pill';
      pill.textContent = ringLabel;
      pill.setAttribute('aria-label', `Зрелость: ${ringLabel}`);
      title.appendChild(pill);
    }

    const chips = document.createElement('div'); chips.className='chips';
    (item.metrics || item.keys || []).slice(0,6).forEach(k=> chip(chips,k));

    a.appendChild(title); a.appendChild(chips);
    boardEl.appendChild(a);
  });
}

// === ПОИСК ===
function setupSearch(){
  const input = document.getElementById('q');
  const clearBtn = document.getElementById('clearBtn');
  if(!input) return;
  const base = [...technologies];
  const norm = (s)=> (s||'').toString().toLowerCase();
  const updateClearState = ()=>{
    if(clearBtn){
      clearBtn.disabled = !input.value.trim();
    }
  };
  function filter(){
    const terms = norm(input.value).split(/\s+/).filter(Boolean);
    if(!terms.length){
      renderBoard(base);
      renderRadar(base);
      updateClearState();
      return;
    }
    const makeBag = (t)=> [t.name, t.slug, t.ring, t.summary, ringLabelsById[t.ring], ...(t.metrics || t.keys || [])]
      .filter(Boolean)
      .map(norm)
      .join(' ');
    let res = base.filter(t=> {
      const bag = makeBag(t);
      return terms.every(term => bag.includes(term));
    });
    if(!res.length){
      res = base.filter(t=> {
        const bag = makeBag(t);
        return terms.some(term => bag.includes(term));
      });
    }
    renderBoard(res);
    renderRadar(res);
    updateClearState();
  }
  input.addEventListener('input', filter);
  if(clearBtn){
    clearBtn.addEventListener('click', ()=>{
      input.value = '';
      filter();
      input.focus();
    });
  }
  updateClearState();
}

// init
  renderRadar(technologies);
  renderBoard(technologies);
  setupSearch();
  let radarResizeTimer;
  window.addEventListener('resize', ()=>{
    clearTimeout(radarResizeTimer);
    radarResizeTimer = setTimeout(()=> renderRadar(lastRadarData), 160);
  });

const loginLink = document.querySelector('.login-link');
function isAuthenticated(){
  try{
    return localStorage.getItem('sci-auth') === 'true';
  } catch(err){
    return false;
  }
}
function configureLoginLink(){
  if(!loginLink) return;
  const authed = isAuthenticated();
  if(authed){
    loginLink.textContent = 'Выйти';
    loginLink.href = './login/';
    loginLink.setAttribute('aria-label', 'Выйти из каталога');
    loginLink.onclick = (event)=>{
      event.preventDefault();
      try{
        localStorage.removeItem('sci-auth');
        localStorage.removeItem('sci-account');
      } catch(err){
        /* ignore */
      }
      window.location.replace('/login/');
    };
  } else {
    loginLink.textContent = 'Войти';
    loginLink.href = './login/';
    loginLink.removeAttribute('aria-label');
    loginLink.onclick = null;
  }
}

configureLoginLink();
window.addEventListener('storage', configureLoginLink);
</script>
</body>
</html>
