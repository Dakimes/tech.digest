<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Главная</title>
  <meta name="description" content="Главная страница каталога: цифровой радар и карточки технологий." />
  <script>
    (function(){
      var doc = document.documentElement;
      doc.classList.add('auth-check');
      try{
        if(localStorage.getItem('sci-auth') === 'true'){
          doc.classList.add('auth-ok');
        } else {
          window.location.replace('/login/');
        }
      } catch(err){
        window.location.replace('/login/');
      }
    })();
  </script>
  <link rel="icon" type="image/png" href="./assets/logo.png" />
  <style>
    html.auth-check body{ visibility:hidden; }
    html.auth-check.auth-ok body{ visibility:visible; }
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#4b5563; --text:#0b0d12;
      --blue-1:#00A7FF; --blue-2:#007BFF; --blue-3:#0062D1; --blue-4:#0047B3; --blue-6:#0B2F80;
      --line:#e6eef8; --shadow: 0 10px 30px rgba(0, 80, 170, .10); --radius:18px;
    }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font:16px/1.55 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width: 1200px; margin: 28px auto 64px; padding: 0 20px; }

    /* Header */
    header.hero{ display:flex; align-items:center; gap:16px; padding:16px 18px; border:1px solid var(--line); border-radius:var(--radius); background:linear-gradient(180deg, #f7fbff 0%, #fff 100%); box-shadow:var(--shadow); flex-wrap:wrap; }
    .logo{ height:56px; width:auto; }
    .brand{ font-weight:800; font-size: clamp(18px,2.2vw,22px); letter-spacing:.2px; color:var(--blue-4); }
    .nav{ margin-left:auto; }
    .login-link{ display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:12px; background:var(--blue-4); color:#fff; font-weight:700; text-decoration:none; box-shadow:0 6px 18px rgba(0,71,179,.18); transition:background .2s ease, transform .2s ease; }
    .login-link:hover{ background:var(--blue-3); transform:translateY(-1px); }
    .login-link:focus-visible{ outline:3px solid rgba(0,123,255,.35); outline-offset:3px; }

    /* Blue top-level taxonomy band */
    .blueband{ margin-top:14px; background: linear-gradient(180deg, var(--blue-4), var(--blue-6)); color:#fff; border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid rgba(255,255,255,.15); }
    .blueband .inner{ display:flex; flex-wrap:wrap; gap:14px 18px; padding:14px 18px; align-items:center; }
    .tagb{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.22); font-size:13px; color:#fff; }
    .legend{ display:flex; flex-wrap:wrap; gap:10px; margin-left:auto; }
    .lg{ display:inline-flex; align-items:center; gap:8px; font-size:12px; opacity:.9; }
    .lg i{ width:10px; height:10px; display:inline-block; border-radius:50%; }
    .m1{ background:#86d6ff; } .m2{ background:#4eb2ff; } .m3{ background:#1c8fff; } .m4{ background:#0b5fd1; }

    /* Search */
    .search{ position:relative; display:flex; gap:10px; margin:18px 0 26px; }
    .search input{ width:100%; border:2px solid var(--blue-2); border-radius:14px; padding:14px 14px 14px 42px; font-size:16px; outline:none; box-shadow: 0 6px 22px rgba(0,123,255,.12); }
    .search input:focus{ border-color: var(--blue-2); box-shadow: 0 0 0 4px rgba(0,123,255,.12); }

    /* Radar */
    .radar-wrap{ position:relative; border:1px solid var(--line); border-radius:var(--radius); padding:16px; background: #fff; box-shadow: var(--shadow); }
    .radar{ position:relative; width:100%; max-width:100%; height: 360px; margin:auto; background:
      radial-gradient(circle at center, rgba(0,123,255,.04) 0 1px, transparent 1px) 0 0/24px 24px; border-radius:14px; overflow:hidden; }
    .radar svg{ position:absolute; inset:0; width:100%; height:100%; }
    .ring-label{ display:block; font-size:12px; fill:var(--blue-4); font-weight:600; opacity:.85; }
    .axis-line{ stroke:rgba(0,71,179,.25); stroke-width:1; stroke-dasharray:4 4; }
    .ring-zone{ stroke:rgba(0,71,179,.35); stroke-width:1.2; }

    .radar-legend{ display:flex; gap:16px; flex-wrap:wrap; align-items:center; justify-content:flex-start; padding-top:10px; font-size:12px; color:#2b3b6a; }
    .radar-legend .lg{ display:inline-flex; align-items:center; gap:8px; }
    .radar-legend i{ width:12px; height:12px; display:inline-block; border-radius:50%; }
    .m1{ background:#86d6ff; } .m2{ background:#4eb2ff; } .m3{ background:#1c8fff; } .m4{ background:#0b5fd1; }

    .dot{ cursor:pointer; transition: opacity .15s ease; }
    .dot circle{ filter: drop-shadow(0 2px 6px rgba(0,0,0,.15)); }
    .dot text{ font-size:12px; font-weight:700; fill:#0b0d12; paint-order: stroke; stroke: #fff; stroke-width: 3px; }
    .dot text[data-align="left"]{ text-anchor:end; }
    .dot text[data-align="center"]{ text-anchor:middle; }

    /* Board */
    h2{ margin: 26px 0 10px; font-size: clamp(20px,2.4vw,28px); color:var(--blue-4); }
    h2::after{ content:""; display:block; width:56px; height:4px; background: linear-gradient(90deg, var(--blue-3), var(--blue-1)); border-radius:2px; margin-top:8px; }

    .board{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:14px; }
    @media (max-width: 980px){ .board{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 760px){
      header.hero{ flex-direction:column; align-items:flex-start; }
      .nav{ width:100%; display:flex; justify-content:flex-start; }
      .login-link{ width:100%; justify-content:center; }
    }
    @media (max-width: 640px){
      .board{ grid-template-columns: 1fr; }
      .radar{ height:320px; }
      .radar-wrap{ padding:12px; }
    }
    @media (max-width: 480px){
      header.hero{ padding:14px; }
      .search{ flex-direction:column; }
      .search input{ padding-left:38px; }
      .radar{ height:280px; }
    }

    .tile{ position:relative; background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow: var(--shadow); text-decoration:none; color:inherit; display:flex; flex-direction:column; gap:10px; }
    .tile:hover{ border-color: var(--blue-2); box-shadow: 0 8px 30px rgba(0,123,255,.12); }
    .tile .title{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; color:var(--blue-3); background:#fff; border:1.6px solid var(--blue-2); }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ background:#fff; border:1.6px solid var(--blue-2); color:var(--blue-3); padding:6px 8px; border-radius:8px; font-size:12px; font-weight:600; }

    footer{ color:var(--muted); font-size:12px; margin-top: 28px; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <img src="./assets/logo.png" alt="SCI logo" class="logo" />
      <div class="brand">Технологический радар</div>
      <nav class="nav" aria-label="Главная навигация">
        <a class="login-link" href="./login/">Войти</a>
      </nav>
    </header>

    <div class="search" role="search">
      <div class="box" style="position:relative; flex:1">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:18px; height:18px; opacity:.6"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"></circle><line x1="16.5" y1="16.5" x2="22" y2="22" stroke="currentColor" stroke-width="2"></line></svg>
        <input id="q" type="search" placeholder="Поиск по технологиям…" aria-label="Поиск по каталогу" autofocus />
      </div>
      <button class="clear" id="clearBtn" type="button" style="border:none; background:#f2f7ff; color:var(--blue-3); padding:12px 14px; border-radius:12px; font-weight:700; cursor:pointer;">Очистить</button>
    </div>

    <section class="radar-wrap" aria-label="Цифровой радар технологий">
      <div id="radar" class="radar"></div>
      <div class="radar-legend" aria-label="Легенда зрелости">
        <span class="lg"><i class="m1"></i>Наблюдение</span>
        <span class="lg"><i class="m2"></i>Пилоты</span>
        <span class="lg"><i class="m3"></i>Продукция</span>
        <span class="lg"><i class="m4"></i>Масштаб</span>
      </div>
    </section>

    <h2>Доска технологий</h2>
    <section id="board" class="board" aria-live="polite"></section>

    <footer>© 2025 • SCI • Главная по технологиям KG</footer>
  </div>

<script>
// === ДАННЫЕ ===
// Базовый субдомен для технологии (замените на ваш домен)
// Путь на домене scisource.ru: https://scisource.ru/<slug>/
const BASE_URL = '/';
const makeLink = (slug) => `${BASE_URL}${slug}/`; 

const technologies = [
  {
    id:'ekg-platform',
    slug:'ekg',
    name:'Платформы корпоративных графов знаний',
    keys:['RDF/OWL','SPARQL 1.2','SHACL/SHEx','JSON‑LD','PROV‑O','SKOS'],
    link: makeLink('ekg'),
    ring:'production',
    angle: 40
  },
  {
    id:'streaming-platforms',
    slug:'streaming',
    name:'Распределённые платформы потоковой передачи событий',
    keys:['Event Time','Stateful Streams','Kafka/Flink','Schema Registry','Exactly-once','CloudEvents'],
    link: makeLink('streaming'),
    ring:'pilot',
    angle: 140
  },
  {
    id:'distributed-streaming-rt',
    slug:'streaming-rt',
    name:'Платформы распределённой потоковой передачи и обработки потоков',
    keys:['Event Time','Watermarks','Streaming SQL','CEP','Schema Registry','Exactly-once'],
    link: makeLink('streaming-rt'),
    ring:'pilot',
    angle: 220
  },
  {
    id:'disaggregated-storage',
    slug:'disaggregated-storage',
    name:'Дезагрегированные распределённые архитектуры хранения',
    keys:['HL7 FHIR R4','OMOP CDM','Bulk Data $export','Terminology Services','SMART on FHIR','Population Analytics'],
    link: makeLink('disaggregated-storage'),
    ring:'pilot',
    angle: 300
  }
];

// === РАДАР ===
const radarEl = document.getElementById('radar');
const rings = [
  {id:'observe',   label:'Наблюдение', r:80,  color:'#86d6ff'},
  {id:'pilot',     label:'Пилоты',     r:130, color:'#4eb2ff'},
  {id:'production',label:'Продукция',  r:180, color:'#1c8fff'},
  {id:'scale',     label:'Масштаб',    r:230, color:'#0b5fd1'}
];
let lastRadarData = technologies;

function polarToXY(cx, cy, r, angleDeg){
  const a = (angleDeg - 90) * Math.PI/180; // 0° вверх
  return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
}

function renderRadar(data){
  lastRadarData = data;
  const w = radarEl.clientWidth || radarEl.offsetWidth || 800;
  const h = radarEl.clientHeight || 360;
  const cx = w/2, cy = h/2;
  const maxR = Math.min(w,h)/2 - 24;
  const scale = maxR / rings[rings.length-1].r;

  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

  const defs = document.createElementNS(svg.namespaceURI,'defs');
  const lg = document.createElementNS(svg.namespaceURI,'linearGradient');
  lg.setAttribute('id','grad'); lg.setAttribute('x1','0'); lg.setAttribute('x2','1');
  const s1 = document.createElementNS(svg.namespaceURI,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','var(--blue-1)');
  const s2 = document.createElementNS(svg.namespaceURI,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','var(--blue-2)');
  lg.appendChild(s1); lg.appendChild(s2); defs.appendChild(lg); svg.appendChild(defs);

  const ringGroup = document.createElementNS(svg.namespaceURI,'g');
  rings.forEach((r, idx)=>{
    const R = r.r * scale;
    const c = document.createElementNS(svg.namespaceURI,'circle');
    c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', R);
    c.setAttribute('class','ring-zone');
    c.setAttribute('fill', idx % 2 === 0 ? 'rgba(0,123,255,.09)' : 'rgba(0,123,255,.05)');
    ringGroup.appendChild(c);

    const t = document.createElementNS(svg.namespaceURI,'text');
    t.setAttribute('x', cx);
    t.setAttribute('y', Math.max(18, cy - R + 14));
    t.setAttribute('class','ring-label');
    t.setAttribute('text-anchor','middle');
    t.textContent = r.label;
    ringGroup.appendChild(t);
  });
  svg.appendChild(ringGroup);

  const axes = document.createElementNS(svg.namespaceURI,'g');
  const axisCount = 8;
  for(let i=0;i<axisCount;i++){
    const angle = (360/axisCount)*i;
    const end = polarToXY(cx, cy, rings[rings.length-1].r * scale, angle);
    const line = document.createElementNS(svg.namespaceURI,'line');
    line.setAttribute('x1', cx); line.setAttribute('y1', cy);
    line.setAttribute('x2', end.x); line.setAttribute('y2', end.y);
    line.setAttribute('class','axis-line');
    axes.appendChild(line);
  }
  svg.appendChild(axes);

  if(!data.length){
    radarEl.innerHTML = '';
    radarEl.appendChild(svg);
    return;
  }

  const labelBoxes = [];

  data.forEach((item, idx)=>{
    const R = (rings.find(r=>r.id===item.ring)?.r || rings[0].r) * scale;
    const pos = polarToXY(cx, cy, R, item.angle || (40 + idx*30));

    const g = document.createElementNS(svg.namespaceURI,'g'); g.setAttribute('class','dot');
    const circle = document.createElementNS(svg.namespaceURI,'circle');
    circle.setAttribute('cx', pos.x); circle.setAttribute('cy', pos.y); circle.setAttribute('r', 10);
    circle.setAttribute('fill','url(#grad)'); circle.setAttribute('stroke','var(--blue-3)'); circle.setAttribute('stroke-width','1');

    const label = document.createElementNS(svg.namespaceURI,'text');
    label.textContent = item.name;

    const align = pos.x < cx - 40 ? 'left' : (pos.x > cx + 40 ? 'right' : 'center');
    let labelX = align === 'left' ? pos.x - 16 : align === 'right' ? pos.x + 16 : pos.x;
    let labelY = pos.y - 12;
    const approxWidth = Math.min(220, item.name.length * 6.8);
    const labelHeight = 18;
    const box = {
      x: align === 'left' ? labelX - approxWidth : labelX,
      y: labelY - labelHeight + 6,
      width: approxWidth,
      height: labelHeight
    };

    if(box.y < 12){
      const diff = 12 - box.y;
      box.y += diff; labelY += diff;
    }

    const collide = (a,b)=> !(a.x + a.width < b.x || b.x + b.width < a.x || a.y + a.height < b.y || b.y + b.height < a.y);
    let guard = 0;
    while(labelBoxes.some(b=>collide(b, box)) && guard < 12){
      box.y += labelHeight;
      labelY += labelHeight;
      guard++;
    }

    if(align === 'right' && box.x + box.width > w - 8){
      const shift = box.x + box.width - (w - 8);
      labelX -= shift;
      box.x -= shift;
    }
    if(align === 'left' && box.x < 8){
      const shift = 8 - box.x;
      labelX += shift;
      box.x += shift;
    }

    label.setAttribute('x', labelX);
    label.setAttribute('y', labelY);
    if(align === 'left'){ label.setAttribute('text-anchor','end'); label.dataset.align='left'; }
    else if(align === 'right'){ label.setAttribute('text-anchor','start'); label.dataset.align='right'; }
    else { label.setAttribute('text-anchor','middle'); label.dataset.align='center'; }

    g.appendChild(circle);
    g.appendChild(label);

    const go = ()=> window.location.href = item.link;
    g.addEventListener('click', go);
    g.setAttribute('role','link'); g.setAttribute('tabindex','0');
    g.addEventListener('keydown', (e)=>{ if(e.key==='Enter') go(); });

    svg.appendChild(g);
    labelBoxes.push(box);
  });

  radarEl.innerHTML = '';
  radarEl.appendChild(svg);
}

// === ДОСКА ===
function chip(el, text){ const s=document.createElement('span'); s.className='chip'; s.textContent=text; el.appendChild(s); }

function renderBoard(list){
  const board = document.getElementById('board');
  board.innerHTML = '';
  list.forEach(item=>{
    const a = document.createElement('a');
    a.href = item.link; a.className='tile'; a.setAttribute('data-id', item.id);

    const title = document.createElement('div'); title.className='title';
    const h = document.createElement('div'); h.style.fontWeight='800'; h.textContent=item.name;
    title.appendChild(h);

    const chips = document.createElement('div'); chips.className='chips';
    item.keys.slice(0,6).forEach(k=> chip(chips,k));

    a.appendChild(title); a.appendChild(chips);
    board.appendChild(a);
  });
}

// === ПОИСК ===
function setupSearch(){
  const input = document.getElementById('q');
  const base = [...technologies];
  function norm(s){ return (s||'').toString().toLowerCase(); }
  function filter(){
    const q = norm(input.value);
    if(!q){ renderBoard(base); renderRadar(base); return; }
    const res = base.filter(t=> {
      const bag = [t.name, t.type, ...(t.keys||[])].map(norm).join(' ');
      return bag.includes(q);
    });
    renderBoard(res); renderRadar(res);
  }
  input.addEventListener('input', filter);
  document.getElementById('clearBtn').addEventListener('click', ()=>{ input.value=''; filter(); input.focus(); });
}

// init
  renderRadar(technologies);
  renderBoard(technologies);
  setupSearch();
  let radarResizeTimer;
  window.addEventListener('resize', ()=>{
    clearTimeout(radarResizeTimer);
    radarResizeTimer = setTimeout(()=> renderRadar(lastRadarData), 160);
  });

const loginLink = document.querySelector('.login-link');
function isAuthenticated(){
  try{
    return localStorage.getItem('sci-auth') === 'true';
  } catch(err){
    return false;
  }
}
function configureLoginLink(){
  if(!loginLink) return;
  const authed = isAuthenticated();
  if(authed){
    loginLink.textContent = 'Выйти';
    loginLink.href = '#logout';
    loginLink.setAttribute('aria-label', 'Выйти из аккаунта');
    loginLink.onclick = (event)=>{
      event.preventDefault();
      try{
        localStorage.removeItem('sci-auth');
      } catch(err){
        /* ignore */
      }
      configureLoginLink();
      window.location.replace('/login/');
    };
  } else {
    loginLink.textContent = 'Войти';
    loginLink.href = './login/';
    loginLink.removeAttribute('aria-label');
    loginLink.onclick = null;
  }
}

configureLoginLink();
window.addEventListener('storage', configureLoginLink);
</script>
</body>
</html>
