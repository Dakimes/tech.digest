<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Главная</title>
  <meta name="description" content="Главная страница каталога: цифровой радар и карточки технологий." />
  <script>
    (function(){
      var doc = document.documentElement;
      doc.classList.add('auth-check');
      try{
        if(localStorage.getItem('sci-auth') === 'true'){
          doc.classList.add('auth-ok');
        } else {
          window.location.replace('/login/');
        }
      } catch(err){
        window.location.replace('/login/');
      }
    })();
  </script>
  <link rel="icon" type="image/png" href="./assets/logo.png" />
  <style>
    html.auth-check body{ visibility:hidden; }
    html.auth-check.auth-ok body{ visibility:visible; }
    :where([hidden]){ display:none !important; }
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#4b5563; --text:#0b0d12;
      --blue-1:#00A7FF; --blue-2:#007BFF; --blue-3:#0062D1; --blue-4:#0047B3; --blue-6:#0B2F80;
      --line:#e6eef8; --shadow: 0 10px 30px rgba(0, 80, 170, .10); --radius:18px;
    }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font:16px/1.55 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width: 1200px; margin: 28px auto 64px; padding: 0 20px; }
    .account-pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px; font-size:12px; font-weight:600; background:#fff; color:var(--blue-4); border:1.4px solid rgba(0,71,179,.22); box-shadow:0 4px 14px rgba(0,71,179,.12); flex-shrink:0; }

    /* Header */
    header.hero{ display:flex; align-items:center; gap:16px; padding:16px 18px; border:1px solid var(--line); border-radius:var(--radius); background:linear-gradient(180deg, #f7fbff 0%, #fff 100%); box-shadow:var(--shadow); flex-wrap:wrap; }
    .logo{ height:56px; width:auto; }
    .brand{ font-weight:800; font-size: clamp(18px,2.2vw,22px); letter-spacing:.2px; color:var(--blue-4); }
    .nav{ margin-left:auto; }
    .login-link{ display:inline-flex; align-items:center; gap:8px; padding:10px 18px; border-radius:12px; background:#fff; color:var(--blue-4); font-weight:700; text-decoration:none; box-shadow:0 6px 22px rgba(0,71,179,.12); border:1.6px solid rgba(0,71,179,.22); transition:background .2s ease, transform .2s ease, box-shadow .2s ease; }
    .login-link:hover{ background:rgba(0,71,179,.06); transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,71,179,.16); }
    .login-link:focus-visible{ outline:3px solid rgba(0,123,255,.28); outline-offset:3px; }

    /* Blue top-level taxonomy band */
    .blueband{ margin-top:14px; background: linear-gradient(180deg, var(--blue-4), var(--blue-6)); color:#fff; border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid rgba(255,255,255,.15); }
    .blueband .inner{ display:flex; flex-wrap:wrap; gap:14px 18px; padding:14px 18px; align-items:center; }
    .tagb{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.22); font-size:13px; color:#fff; }
    .legend{ display:flex; flex-wrap:wrap; gap:10px; margin-left:auto; }
    .lg{ display:inline-flex; align-items:center; gap:8px; font-size:12px; opacity:.9; }
    .lg i{ width:10px; height:10px; display:inline-block; border-radius:50%; }
    .m1{ background:#86d6ff; } .m2{ background:#4eb2ff; } .m3{ background:#1c8fff; } .m4{ background:#0b5fd1; }

    /* Search */
    .search{ position:relative; display:flex; gap:10px; margin:18px 0 26px; }
    .search input{ width:100%; border:1.6px solid var(--line); border-radius:14px; padding:14px 14px 14px 42px; font-size:16px; outline:none; box-shadow:none; }
    .search input:focus{ border-color: rgba(0,71,179,.28); box-shadow:none; }
    .search .clear{
      border:none;
      background:#f6f8fb;
      color:var(--muted);
      padding:12px 14px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      transition:background .2s ease, color .2s ease;
    }
    .search .clear:hover:not(:disabled){ background:#edf1f7; color:var(--blue-3); }
    .search .clear:focus-visible{ outline:2px solid rgba(0,71,179,.24); outline-offset:3px; }
    .search .clear:disabled{
      opacity:.65;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* Radar */
    .radar-wrap{ position:relative; border:1px solid var(--line); border-radius:var(--radius); padding:20px 20px 28px; background: #fff; box-shadow: var(--shadow); }
    .radar{ position:relative; width:100%; max-width:100%; height: clamp(460px, 60vw, 640px); margin:auto; background:
      radial-gradient(circle at center, rgba(0,123,255,.04) 0 1px, transparent 1px) 0 0/24px 24px; border-radius:18px; overflow:hidden; }
    .radar-empty{
      position:absolute;
      inset:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      background:rgba(255,255,255,.92);
      border:1px dashed var(--line);
      border-radius:12px;
      color:var(--muted);
      font-weight:600;
      padding:18px;
      pointer-events:none;
    }
    .radar svg{ position:absolute; inset:0; width:100%; height:100%; }
    .ring-label{ display:block; font-size:12px; fill:var(--blue-4); font-weight:600; opacity:.85; }
    .axis-line{ stroke:rgba(0,71,179,.25); stroke-width:1; stroke-dasharray:4 4; }
    .ring-zone{ stroke:rgba(0,71,179,.35); stroke-width:1.2; }

    .dot{ cursor:pointer; transition: opacity .15s ease; outline:none; }
    .dot circle{ filter: drop-shadow(0 6px 18px rgba(0,71,179,.22)); }
    .dot-label{ font-size:12px; font-weight:700; fill:#ffffff; text-anchor:middle; dominant-baseline:middle; paint-order:stroke; stroke:rgba(11,13,18,.18); stroke-width:3; }
    .dot:focus-visible circle{ outline:3px solid rgba(0,123,255,.45); outline-offset:2px; }
    .radar-tooltip{
      position:absolute;
      pointer-events:none;
      background:#ffffff;
      color:#0b0d12;
      padding:12px 14px;
      border-radius:12px;
      font-size:13px;
      line-height:1.45;
      box-shadow:0 18px 38px rgba(0, 71, 179, .18);
      max-width:260px;
      z-index:20;
      transform:translate(-50%, -120%);
      opacity:0;
      border:1px solid rgba(0,71,179,.12);
      transition:opacity .12s ease;
    }
    .radar-tooltip.is-visible{ opacity:1; }
    .radar-tooltip strong{ display:block; font-size:14px; margin-bottom:6px; color:var(--blue-4); }
    .radar-tooltip span{ display:block; font-size:12px; color:var(--muted); }
    .radar-tooltip ul{ margin:6px 0 0; padding-left:18px; color:var(--muted); }
    .radar-tooltip li{ margin:2px 0; }

    /* Board */
    h2{
      margin: 26px 0 16px;
      font-size: clamp(20px,2.4vw,28px);
      color:var(--blue-4);
      padding-bottom:12px;
      background:
        linear-gradient(90deg, var(--blue-3), var(--blue-1))
        no-repeat left bottom / 56px 4px;
    }

    .board{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:14px; }
    .board-empty{
      margin: 18px 0 0;
      padding:18px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#f5f8ff;
      color:var(--muted);
      text-align:center;
      font-weight:600;
      box-shadow:var(--shadow);
    }
    @media (max-width: 980px){ .board{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 760px){
      header.hero{ flex-direction:column; align-items:flex-start; }
      .nav{ width:100%; display:flex; justify-content:flex-start; }
      .login-link{ width:100%; justify-content:center; }
    }
    @media (max-width: 640px){
      .board{ grid-template-columns: 1fr; }
      .radar{ height: clamp(360px, 90vw, 520px); }
      .radar-wrap{ padding:14px; }
    }
    @media (max-width: 480px){
      header.hero{ padding:14px; }
      .search{ flex-direction:column; }
      .search input{ padding-left:38px; }
      .radar{ height: clamp(320px, 110vw, 440px); }
    }

    @media print{
      .radar-tooltip{ display:none !important; }
    }

    .tile{ position:relative; background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow: var(--shadow); text-decoration:none; color:inherit; display:flex; flex-direction:column; gap:10px; }
    .tile:hover{ border-color: var(--blue-2); box-shadow: 0 8px 30px rgba(0,123,255,.12); }
    .tile .title{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .tile .num{ font-weight:700; font-size:14px; letter-spacing:.5px; color:var(--blue-4); margin-right:6px; width:34px; height:34px; border-radius:50%; background:linear-gradient(135deg, rgba(0,123,255,.18), rgba(0,71,179,.28)); display:inline-flex; align-items:center; justify-content:center; box-shadow:none; flex-shrink:0; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; color:var(--blue-3); background:#fff; border:1.6px solid var(--blue-2); }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ background:#fff; border:1.6px solid var(--blue-2); color:var(--blue-3); padding:6px 8px; border-radius:8px; font-size:12px; font-weight:600; }

    footer{ color:var(--muted); font-size:12px; margin-top: 28px; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <img src="./assets/logo.png" alt="SCI logo" class="logo" />
      <div class="brand" id="projectBrand">Технологический радар</div>
      <div id="accountBadge" class="account-pill" hidden></div>
      <nav class="nav" aria-label="Главная навигация">
        <a class="login-link" href="./login/">Выйти</a>
      </nav>
    </header>

    <div class="search" role="search">
      <div class="box" style="position:relative; flex:1">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:18px; height:18px; opacity:.6"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"></circle><line x1="16.5" y1="16.5" x2="22" y2="22" stroke="currentColor" stroke-width="2"></line></svg>
        <input id="q" type="search" placeholder="Поиск по технологиям…" aria-label="Поиск по каталогу" autofocus />
      </div>
      <button class="clear" id="clearBtn" type="button">Очистить</button>
    </div>

    <section class="radar-wrap" aria-label="Цифровой радар технологий">
      <div id="radar" class="radar"></div>
      <div id="radarEmpty" class="radar-empty" hidden role="status" aria-live="polite">Нет технологий для отображения. Измените поисковый запрос.</div>
    </section>

    <h2>Доска технологий</h2>
    <section id="board" class="board" aria-live="polite"></section>
    <p id="boardEmpty" class="board-empty" hidden role="status" aria-live="polite">По текущему запросу технологий не найдено. Попробуйте изменить критерии поиска.</p>

    <footer>© 2025 SciArticle</footer>
  </div>

<script>
// === ДАННЫЕ ===
// Базовый субдомен для технологии (замените на ваш домен)
// Путь на домене scisource.ru: https://scisource.ru/<slug>/
const BASE_URL = '/';
const cleanSlug = (slug = '') => slug.toString().replace(/^\/+|\/+$/g, '');
const makeLink = (slug = '') => {
  const clean = cleanSlug(slug);
  return clean ? `${BASE_URL}${clean}/` : '#';
};

const accountConfigs = {
  'Admin': {
    projectName: 'Главная по технологиям KG',
    pageTitle: 'Технологический радар',
    accessLabel: 'Data',
    technologies: [
      {
        id:'ekg-platform',
        slug:'ekg',
        name:'Платформы корпоративных графов знаний',
        summary:'Построение и эксплуатация онтологий, фабрик данных и графовых витрин для корпоративных сценариев.',
        metrics:['RDF/OWL','SPARQL 1.2','SHACL/SHEx','JSON‑LD','PROV‑O','SKOS'],
        ring:'production',
        angle: 40
      },
      {
        id:'semantic-pipelines',
        slug:'semantic-pipelines',
        name:'Семантические конвейеры интеграции и обработки данных',
        summary:'Автоматизация извлечения и обогащения данных для RAG и аналитики через семантические пайплайны.',
        metrics:['Hybrid Vector-SQL • ANN/HNSW','ISO GQL • SPARQL 1.2 • PROV-O','Semantic Retrieval • RAG Pipelines'],
        ring:'pilot',
        angle: 110
      },
      {
        id:'streaming-platforms',
        slug:'streaming',
        name:'Распределённые платформы потоковой передачи событий',
        summary:'Надёжная доставка событий и аналитика в реальном времени для продуктовых и операционных сценариев.',
        metrics:['Event Time','Stateful Streams','Kafka/Flink','Schema Registry','Exactly-once','CloudEvents'],
        ring:'pilot',
        angle: 180
      },
      {
        id:'distributed-streaming-rt',
        slug:'streaming-rt',
        name:'Платформы распределённой потоковой обработки',
        summary:'Потоковые вычисления, CEP и SQL-процессы для миссии критичных real-time сервисов.',
        metrics:['Event Time','Watermarks','Streaming SQL','CEP','Schema Registry','Exactly-once'],
        ring:'pilot',
        angle: 250
      },
      {
        id:'blockchain-governance',
        slug:'blockchain-governance',
        name:'Корпоративные системы управления данными и целостностью',
        summary:'Трассируемость, аудит и совместимость данных через DLT и онтологические политики.',
        metrics:['RDF/RDFS','OWL 2','SPARQL 1.2','SHACL','PROV-O','OBDA/R2RML'],
        ring:'pilot',
        angle: 320
      },
      {
        id:'disaggregated-storage',
        slug:'disaggregated-storage',
        name:'Дезагрегированные распределённые архитектуры хранения',
        summary:'Отделение вычислений и хранения для масштабируемых дата-платформ с интероперабельностью.',
        metrics:['HL7 FHIR R4/R5','OMOP CDM','FHIR Bulk Data $export','Terminology Services','SMART on FHIR / OAuth 2.0','Parquet & BigQuery'],
        ring:'observe',
        angle: 10
      }
    ]
  },
  'Admin1': {
    projectName: 'SaaS Portfolio',
    pageTitle: 'Технологический радар — SaaS Portfolio',
    accessLabel: 'МИТ',
    technologies: [
      {
        id:'plg-activation',
        slug:'saas/product-led-growth',
        name:'Product-Led Growth Activation Platforms',
        summary:'In-app онбординг, персонализация и телеметрия поведения для ускорения активации пользователей.',
        metrics:['Activation cohorts','Usage telemetry','In-app guides','Progress nudges'],
        ring:'production',
        angle: 35
      },
      {
        id:'revops-automation',
        slug:'saas/revops-automation',
        name:'Revenue Operations Automation',
        summary:'Оркестрация лидов, биллинга и QBR через единый RevOps-плейбук и AI-подсказки.',
        metrics:['Billing sync','AI playbooks','Lead scoring','Pipeline health'],
        ring:'pilot',
        angle: 120
      },
      {
        id:'customer-success-ai',
        slug:'saas/customer-intelligence',
        name:'Customer Intelligence & Success AI',
        summary:'Прогноз оттока и рекомендации по расширению контрактов для команд customer success.',
        metrics:['Churn models','Expansion signals','Health scoring','Voice-of-customer AI'],
        ring:'pilot',
        angle: 210
      },
      {
        id:'pricing-experiments',
        slug:'saas/pricing-experiments',
        name:'Pricing Experimentation & Packaging',
        summary:'Динамическое тестирование тарифов и пакетов с анализом эластичности и willingness-to-pay.',
        metrics:['Elasticity modeling','Offer A/B','Usage metering','Deal desk automation'],
        ring:'observe',
        angle: 300
      }
    ]
  }
};

const defaultAccountId = 'Admin';

function resolveAccount(){
  let accountId = defaultAccountId;
  try{
    const stored = localStorage.getItem('sci-account');
    if(stored && accountConfigs[stored]){
      accountId = stored;
    }
  } catch(err){
    /* ignore */
  }
  return { id: accountId, config: accountConfigs[accountId] };
}

const { id: activeAccountId, config: activeAccountConfig } = resolveAccount();
const technologies = (activeAccountConfig?.technologies || []).map((item, index)=>{
  const metrics = Array.isArray(item.metrics) ? item.metrics : Array.isArray(item.keys) ? item.keys : [];
  const link = item.link || makeLink(item.slug || '');
  return { ...item, metrics, link, order: index + 1 };
});

const brandEl = document.getElementById('projectBrand');
const baseBrand = 'Технологический радар';
if(brandEl){
  const projectName = activeAccountConfig?.projectName;
  brandEl.textContent = projectName ? `${baseBrand} — ${projectName}` : baseBrand;
}
const accountBadgeEl = document.getElementById('accountBadge');
if(accountBadgeEl){
  const badgeLabel = activeAccountConfig?.accessLabel || 'Тестовый доступ';
  accountBadgeEl.textContent = badgeLabel;
  accountBadgeEl.hidden = false;
}
if(activeAccountConfig?.pageTitle){ document.title = activeAccountConfig.pageTitle; }

// === РАДАР ===
const radarEl = document.getElementById('radar');
const radarEmptyEl = document.getElementById('radarEmpty');
const radarWrapEl = radarEl ? radarEl.parentElement : null;
const boardEl = document.getElementById('board');
const boardEmptyEl = document.getElementById('boardEmpty');
const rings = [
  {id:'observe',   label:'Наблюдение', r:140, color:'#86d6ff'},
  {id:'pilot',     label:'Пилоты',     r:220, color:'#4eb2ff'},
  {id:'production',label:'Продукция',  r:300, color:'#1c8fff'},
  {id:'scale',     label:'Масштаб',    r:380, color:'#0b5fd1'}
];
const ringLabelsById = rings.reduce((acc, ring)=>{ acc[ring.id] = ring.label; return acc; }, {});
let lastRadarData = technologies;
let radarTooltipEl = null;
let radarTooltipTimer = null;

if(radarWrapEl){
  radarTooltipEl = radarWrapEl.querySelector('.radar-tooltip');
  if(!radarTooltipEl){
    radarTooltipEl = document.createElement('div');
    radarTooltipEl.className = 'radar-tooltip';
    radarTooltipEl.setAttribute('role','tooltip');
    radarTooltipEl.hidden = true;
    radarWrapEl.appendChild(radarTooltipEl);
  }
}

function polarToXY(cx, cy, r, angleDeg){
  const a = (angleDeg - 90) * Math.PI/180; // 0° вверх
  return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
}

function renderRadar(data){
  if(!radarEl){ return; }
  const items = Array.isArray(data) ? data : [];
  lastRadarData = items;
  const w = radarEl.clientWidth || radarEl.offsetWidth || 800;
  const h = radarEl.clientHeight || radarEl.offsetHeight || 520;
  if(radarTooltipEl){
    if(radarTooltipTimer !== null){ cancelAnimationFrame(radarTooltipTimer); radarTooltipTimer = null; }
    radarTooltipEl.classList.remove('is-visible');
    radarTooltipEl.hidden = true;
  }
  const cx = w/2, cy = h/2;
  const maxR = Math.min(w,h)/2 - 36;
  const scale = maxR / rings[rings.length-1].r;

  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

  const defs = document.createElementNS(svg.namespaceURI,'defs');
  const lg = document.createElementNS(svg.namespaceURI,'linearGradient');
  lg.setAttribute('id','grad'); lg.setAttribute('x1','0'); lg.setAttribute('x2','1');
  const s1 = document.createElementNS(svg.namespaceURI,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','var(--blue-1)');
  const s2 = document.createElementNS(svg.namespaceURI,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','var(--blue-2)');
  lg.appendChild(s1); lg.appendChild(s2); defs.appendChild(lg); svg.appendChild(defs);

  const ringGroup = document.createElementNS(svg.namespaceURI,'g');
  rings.forEach((r, idx)=>{
    const R = r.r * scale;
    const c = document.createElementNS(svg.namespaceURI,'circle');
    c.setAttribute('cx', cx); c.setAttribute('cy', cy); c.setAttribute('r', R);
    c.setAttribute('class','ring-zone');
    c.setAttribute('fill', idx % 2 === 0 ? 'rgba(0,123,255,.09)' : 'rgba(0,123,255,.05)');
    ringGroup.appendChild(c);

    const t = document.createElementNS(svg.namespaceURI,'text');
    t.setAttribute('x', cx);
    t.setAttribute('y', Math.max(18, cy - R + 14));
    t.setAttribute('class','ring-label');
    t.setAttribute('text-anchor','middle');
    t.textContent = r.label;
    ringGroup.appendChild(t);
  });
  svg.appendChild(ringGroup);

  const axes = document.createElementNS(svg.namespaceURI,'g');
  const axisCount = 8;
  for(let i=0;i<axisCount;i++){
    const angle = (360/axisCount)*i;
    const end = polarToXY(cx, cy, rings[rings.length-1].r * scale, angle);
    const line = document.createElementNS(svg.namespaceURI,'line');
    line.setAttribute('x1', cx); line.setAttribute('y1', cy);
    line.setAttribute('x2', end.x); line.setAttribute('y2', end.y);
    line.setAttribute('class','axis-line');
    axes.appendChild(line);
  }
  svg.appendChild(axes);

  if(!items.length){
    radarEl.innerHTML = '';
    radarEl.appendChild(svg);
    if(radarEmptyEl){ radarEmptyEl.hidden = false; }
    if(radarTooltipEl){
      if(radarTooltipTimer !== null){ cancelAnimationFrame(radarTooltipTimer); radarTooltipTimer = null; }
      radarTooltipEl.classList.remove('is-visible');
      radarTooltipEl.hidden = true;
    }
    return;
  }

  items.forEach((item, idx)=>{
    const R = (rings.find(r=>r.id===item.ring)?.r || rings[0].r) * scale;
    const pos = polarToXY(cx, cy, R, item.angle || (40 + idx*30));
    const orderLabel = (item.order || idx + 1).toString().padStart(2,'0');

    const g = document.createElementNS(svg.namespaceURI,'g');
    g.setAttribute('class','dot');
    g.setAttribute('data-id', item.id);
    g.setAttribute('data-order', orderLabel);

    const circle = document.createElementNS(svg.namespaceURI,'circle');
    circle.setAttribute('cx', pos.x); circle.setAttribute('cy', pos.y); circle.setAttribute('r', 14);
    circle.setAttribute('fill','url(#grad)');
    circle.setAttribute('stroke','var(--blue-3)');
    circle.setAttribute('stroke-width','1');
    circle.setAttribute('aria-hidden','true');
    g.appendChild(circle);

    const label = document.createElementNS(svg.namespaceURI,'text');
    label.setAttribute('class','dot-label');
    label.setAttribute('x', pos.x);
    label.setAttribute('y', pos.y + 1);
    label.setAttribute('pointer-events','none');
    label.textContent = orderLabel;
    g.appendChild(label);

    const go = ()=> window.location.href = item.link;
    g.addEventListener('click', go);
    g.setAttribute('role','link'); g.setAttribute('tabindex','0');
    g.addEventListener('keydown', (e)=>{ if(e.key==='Enter') go(); });

    const textParts = [item.summary, ...(item.metrics || [])];
    const ariaSummary = textParts.filter(Boolean).join('. ');
    g.setAttribute('aria-label', ariaSummary ? `${orderLabel}. ${item.name}. ${ariaSummary}` : `${orderLabel}. ${item.name}`);

    const showTooltip = ()=>{
      if(!radarTooltipEl || !radarWrapEl){ return; }
      const metricsList = (item.metrics || []).slice(0,5).map(m=>`<li>${m}</li>`).join('');
      const summaryHtml = item.summary ? `<span>${item.summary}</span>` : '';
      const metricsHtml = metricsList ? `<ul>${metricsList}</ul>` : '';
      radarTooltipEl.innerHTML = `<strong>${orderLabel}. ${item.name}</strong>${summaryHtml}${metricsHtml}`;
      const wrapRect = radarWrapEl.getBoundingClientRect();
      const svgRect = svg.getBoundingClientRect();
      const scaleX = svgRect.width / w;
      const scaleY = svgRect.height / h;
      const left = svgRect.left - wrapRect.left + pos.x * scaleX;
      const top = svgRect.top - wrapRect.top + pos.y * scaleY;
      radarTooltipEl.style.left = `${left}px`;
      radarTooltipEl.style.top = `${top}px`;
      radarTooltipEl.hidden = false;
      if(radarTooltipTimer !== null){ cancelAnimationFrame(radarTooltipTimer); }
      radarTooltipTimer = requestAnimationFrame(()=>{
        radarTooltipEl.classList.add('is-visible');
        radarTooltipTimer = null;
      });
    };
    const hideTooltip = ()=>{
      if(!radarTooltipEl){ return; }
      if(radarTooltipTimer !== null){ cancelAnimationFrame(radarTooltipTimer); radarTooltipTimer = null; }
      radarTooltipEl.classList.remove('is-visible');
      radarTooltipEl.hidden = true;
    };
    g.addEventListener('mouseenter', showTooltip);
    g.addEventListener('focus', showTooltip);
    g.addEventListener('mouseleave', hideTooltip);
    g.addEventListener('blur', hideTooltip);
    g.addEventListener('touchstart', showTooltip, { passive: true });
    g.addEventListener('touchend', hideTooltip);
    g.addEventListener('touchcancel', hideTooltip);

    svg.appendChild(g);
  });

  radarEl.innerHTML = '';
  radarEl.appendChild(svg);
  if(radarEmptyEl){ radarEmptyEl.hidden = true; }
  if(radarTooltipEl){
    if(radarTooltipTimer !== null){ cancelAnimationFrame(radarTooltipTimer); radarTooltipTimer = null; }
    radarTooltipEl.classList.remove('is-visible');
    radarTooltipEl.hidden = true;
  }
}

// === ДОСКА ===
function chip(el, text){ const s=document.createElement('span'); s.className='chip'; s.textContent=text; el.appendChild(s); }

function renderBoard(list){
  if(!boardEl) return;
  const items = Array.isArray(list) ? list : [];
  boardEl.innerHTML = '';
  const hasItems = items.length > 0;
  if(boardEmptyEl){
    boardEmptyEl.hidden = hasItems;
  }
  if(!hasItems){
    return;
  }
  items.forEach((item, idx)=>{
    const a = document.createElement('a');
    a.href = item.link; a.className='tile'; a.setAttribute('data-id', item.id);

    const title = document.createElement('div'); title.className='title';
    const head = document.createElement('div');
    head.style.display = 'flex';
    head.style.alignItems = 'flex-start';
    head.style.gap = '8px';
    head.style.flex = '1';

    const number = document.createElement('span');
    number.className = 'num';
    number.textContent = (item.order || idx + 1).toString().padStart(2,'0');

    const h = document.createElement('span');
    h.style.fontWeight='800';
    h.style.flex='1';
    h.textContent=item.name;

    head.appendChild(number);
    head.appendChild(h);
    title.appendChild(head);

    const ringLabel = ringLabelsById[item.ring];
    if(ringLabel){
      const pill = document.createElement('span');
      pill.className = 'pill';
      pill.textContent = ringLabel;
      pill.setAttribute('aria-label', `Зрелость: ${ringLabel}`);
      title.appendChild(pill);
    }

    const chips = document.createElement('div'); chips.className='chips';
    (item.metrics || item.keys || []).slice(0,6).forEach(k=> chip(chips,k));

    a.appendChild(title); a.appendChild(chips);
    boardEl.appendChild(a);
  });
}

// === ПОИСК ===
function setupSearch(){
  const input = document.getElementById('q');
  const clearBtn = document.getElementById('clearBtn');
  if(!input) return;
  const base = [...technologies];
  const norm = (s)=> (s||'').toString().toLowerCase();
  const updateClearState = ()=>{
    if(clearBtn){
      clearBtn.disabled = !input.value.trim();
    }
  };
  function filter(){
    const terms = norm(input.value).split(/\s+/).filter(Boolean);
    if(!terms.length){
      renderBoard(base);
      renderRadar(base);
      updateClearState();
      return;
    }
    const makeBag = (t)=> [t.name, t.slug, t.ring, t.summary, ringLabelsById[t.ring], ...(t.metrics || t.keys || [])]
      .filter(Boolean)
      .map(norm)
      .join(' ');
    let res = base.filter(t=> {
      const bag = makeBag(t);
      return terms.every(term => bag.includes(term));
    });
    if(!res.length){
      res = base.filter(t=> {
        const bag = makeBag(t);
        return terms.some(term => bag.includes(term));
      });
    }
    renderBoard(res);
    renderRadar(res);
    updateClearState();
  }
  input.addEventListener('input', filter);
  if(clearBtn){
    clearBtn.addEventListener('click', ()=>{
      input.value = '';
      filter();
      input.focus();
    });
  }
  updateClearState();
}

// init
  renderRadar(technologies);
  renderBoard(technologies);
  setupSearch();
  let radarResizeTimer;
  window.addEventListener('resize', ()=>{
    clearTimeout(radarResizeTimer);
    radarResizeTimer = setTimeout(()=> renderRadar(lastRadarData), 160);
  });

const loginLink = document.querySelector('.login-link');
function isAuthenticated(){
  try{
    return localStorage.getItem('sci-auth') === 'true';
  } catch(err){
    return false;
  }
}
function configureLoginLink(){
  if(!loginLink) return;
  const authed = isAuthenticated();
  if(authed){
    loginLink.textContent = 'Выйти';
    loginLink.href = './login/';
    loginLink.setAttribute('aria-label', 'Выйти из каталога');
    loginLink.onclick = (event)=>{
      event.preventDefault();
      try{
        localStorage.removeItem('sci-auth');
        localStorage.removeItem('sci-account');
      } catch(err){
        /* ignore */
      }
      window.location.replace('/login/');
    };
  } else {
    loginLink.textContent = 'Войти';
    loginLink.href = './login/';
    loginLink.removeAttribute('aria-label');
    loginLink.onclick = null;
  }
}

configureLoginLink();
window.addEventListener('storage', configureLoginLink);
</script>
</body>
</html>
